on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
    secrets:
      azureClientId:
        required: true
      azureTenantId:
        required: true
      azureSubscriptionId:
        required: true

jobs: 
  bicep-deploy:
    name: Bicep Create Deploy
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment}}

    defaults:
        run:
          shell: bash

    steps:

    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Login to Azure using OIDC
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.azureClientId }}
        tenant-id: ${{ secrets.azureTenantId }}
        subscription-id: ${{ secrets.azureSubscriptionId }}

    
    # - name: Deploy Bicep file using Azure CLI
    #   run: |
    #     az deployment group create \
    #       --resource-group ${{ vars.RESOURCE_GROUP }} \
    #       --template-file ${{ vars.BICEP_WORKING_DIRECTORY}}/main.bicep

      # Deploy Bicep file
    - name: Deploy Bicep file using Azure Action
      id: deploy
      uses: azure/arm-deploy@v1
      with:
        subscriptionId: ${{ secrets.azureSubscriptionId }}
        resourceGroupName: ${{ vars.RESOURCE_GROUP }}
        template: ${{ vars.BICEP_WORKING_DIRECTORY}}/main.bicep
        # parameters: 'storagePrefix=mystore storageSKU=Standard_LRS'
        failOnStdErr: false

    - name: Display Deployment Outputs
      run: |
        echo "::notice::âœ… Deployment completed successfully"
        echo "::notice::ï¿½ Resource Group: ${{ vars.RESOURCE_GROUP }}"
        echo "::notice::ðŸŒ Environment: ${{ inputs.environment }}"
        echo ""
        echo "Fetching deployment outputs..."
        
        # Get the latest deployment name
        deploymentName=$(az deployment group list \
          --resource-group ${{ vars.RESOURCE_GROUP }} \
          --query "[0].name" -o tsv)
        
        echo "::notice::ï¿½ Deployment Name: $deploymentName"
        
        # Get all outputs dynamically
        outputs=$(az deployment group show \
          --name "$deploymentName" \
          --resource-group ${{ vars.RESOURCE_GROUP }} \
          --query "properties.outputs" -o json)
        
        # Display outputs as annotations
        echo "$outputs" | jq -r 'to_entries[] | "::notice::\(.key): \(.value.value)"'
        
        # Dynamically add all outputs to the table
        echo "$outputs" | jq -r 'to_entries[] | "| `\(.key)` | `\(.value.value)` |"' >> $GITHUB_STEP_SUMMARY
