on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
    secrets:
      azureClientId:
        required: true
      azureTenantId:
        required: true
      azureSubscriptionId:
        required: true

jobs: 
  bicep-deploy:
    name: Bicep Create Deploy
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment}}

    defaults:
        run:
          shell: bash

    steps:

    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Login to Azure using OIDC
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.azureClientId }}
        tenant-id: ${{ secrets.azureTenantId }}
        subscription-id: ${{ secrets.azureSubscriptionId }}

      # Deploy Bicep file
    - name: Deploy Bicep file using Azure Action
      id: deploy
      uses: azure/arm-deploy@v1
      with:
        subscriptionId: ${{ secrets.azureSubscriptionId }}
        resourceGroupName: ${{ vars.RESOURCE_GROUP }}
        template: ${{ vars.BICEP_WORKING_DIRECTORY}}/main.bicep
        failOnStdErr: false

    - name: Display Deployment Outputs
      run: |
        echo "Deployment completed successfully"
        echo "Resource Group: ${{ vars.RESOURCE_GROUP }}"
        echo "Environment: ${{ inputs.environment }}"
        echo "Deployment Name: ${{ steps.deploy.outputs.deploymentName }}"
        echo ""
        echo "Fetching all outputs from main.bicep deployment..."
        
        # Get all outputs dynamically from the MAIN deployment (not child modules)
        outputs=$(az deployment group show \
          --name "${{ steps.deploy.outputs.deploymentName }}" \
          --resource-group ${{ vars.RESOURCE_GROUP }} \
          --query "properties.outputs" -o json)
        
        echo ""
        echo "Outputs from main.bicep:"
        echo "$outputs" | jq -r 'to_entries[] | "  \(.key) = \(.value.value)"'
        
        echo ""
        echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | \`${{ inputs.environment }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Resource Group | \`${{ vars.RESOURCE_GROUP }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| Deployment Name | \`${{ steps.deploy.outputs.deploymentName }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Outputs from main.bicep" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Output Name | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-------------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "$outputs" | jq -r 'to_entries[] | "| \(.key) | \(.value.value) |"' >> $GITHUB_STEP_SUMMARY
