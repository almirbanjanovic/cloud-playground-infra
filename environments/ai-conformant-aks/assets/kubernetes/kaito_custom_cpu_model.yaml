apiVersion: kaito.sh/v1beta1
kind: Workspace
metadata:
  name: ${name}
  namespace: ${namespace}

resource:
  instanceType: ${instanceType}   # Standard_D4s_v5 recommended for bloomz-560m (~2.2GB model)
  labelSelector:
    matchLabels:
      apps: bloomz-560m 

inference:
  template:
    spec:

      containers:
        - name: custom-llm-container
          image: mcr.microsoft.com/aks/kaito/kaito-base:0.0.8

          resources:
            requests:
              memory: "8Gi"
              cpu: "2"
            limits:
              memory: "16Gi"
              cpu: "4"

          env:
            - name: OMP_NUM_THREADS
              value: "4"  # Match CPU limit for optimal threading
            - name: TOKENIZERS_PARALLELISM
              value: "false"  # Avoids deadlock warnings with HuggingFace tokenizers

          livenessProbe:
            httpGet:
              path: /health
              port: 5000
              scheme: HTTP
            initialDelaySeconds: 300  # Increased - model loading can take time on CPU
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /health
              port: 5000
              scheme: HTTP
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          command:
            - "accelerate"
          args:
            - "launch"
            - "--num_processes"
            - "1"
            - "--num_machines"
            - "1"
            - "tfs/inference_api.py"
            - "--pipeline"
            - "text-generation"
            - "--trust_remote_code"
            - "--allow_remote_files"
            - "--pretrained_model_name_or_path"
            - "bigscience/bloomz-560m" # Find additional info at https://huggingface.co/bigscience/bloomz-560m
            - "--torch_dtype"
            - "float32"   # CPU-safe; required for D-series

          volumeMounts:
            - name: dshm
              mountPath: /dev/shm

      volumes:
        - name: dshm
          emptyDir:
            medium: Memory